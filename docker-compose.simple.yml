# Simple Docker Compose - Complete Demo Environment
#
# Usage: docker compose -f docker-compose.simple.yml up
#
# This demo creates a complete MoQT network:
#   - 1 SDN Controller (manages topology)
#   - 3 Relay Servers (relay-tokyo, relay-london, relay-newyork)
#
# Relays self-register their topology via heartbeat (no setup service needed).
# Everything runs in Docker - no shell scripts needed!
# Works the same on Windows, macOS, and Linux.
#
# Access:
#   - SDN Controller:  http://localhost:8090
#   - Relay Tokyo:     https://localhost:4433 (Health: http://localhost:8080)
#   - Relay London:    https://localhost:4434 (Health: http://localhost:8081)
#   - Relay New York:  https://localhost:4435 (Health: http://localhost:8082)

services:
  # SDN Controller - Network Brain
  sdn:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-sdn
    command: ["sdn", "-config", "/tmp/config.sdn.yaml"]
    ports:
      - "8090:8090"
    environment:
      - SDN_ADDR=:8090
      - DATA_DIR=/data
      - NODE_TTL_SEC=90
    volumes:
      - sdn-data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8090/graph"]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    networks:
      qumo-net:
        aliases:
          - sdn

  # Relay Server - Tokyo
  relay-tokyo:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-tokyo
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4433:4433/udp"
      - "8080:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-tokyo
      - REGION=asia
      - NEIGHBORS=relay-london:250
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - London
  relay-london:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-london
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4434:4433/udp"
      - "8081:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-london
      - REGION=europe
      - NEIGHBORS=relay-tokyo:250,relay-newyork:80
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - New York
  relay-newyork:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-newyork
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4435:4433/udp"
      - "8082:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-newyork
      - REGION=americas
      - NEIGHBORS=relay-london:80
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

networks:
  qumo-net:
    driver: bridge

volumes:
  sdn-data:

# How it works:
#
# 1. Start everything:
#    docker compose -f docker-compose.simple.yml up
#
#    Each relay self-registers its neighbors via topology heartbeat.
#    No setup service needed â€” the SDN graph builds itself!
#
# 2. Explore the network:
#    # View topology graph
#    curl http://localhost:8090/graph | jq
#
#    # Find shortest path from Tokyo to New York
#    curl "http://localhost:8090/route?from=relay-tokyo&to=relay-newyork"
#
#    # Check relay health
#    curl http://localhost:8080/health  # Tokyo
#    curl http://localhost:8081/health  # London
#    curl http://localhost:8082/health  # New York
#
# 3. View logs:
#    docker compose -f docker-compose.simple.yml logs -f
#
# 4. Stop demo:
#    docker compose -f docker-compose.simple.yml down
#
# No shell scripts required! Works the same on all platforms.
