# Simple Docker Compose - Complete Demo Environment
#
# Usage: docker compose -f docker compose.simple.yml up
#
# This demo creates a complete MoQT network:
#   - 1 SDN Controller (manages topology)
#   - 3 Relay Servers (relay-tokyo, relay-london, relay-newyork)
#   - Auto-setup (configures network topology automatically)
#
# Everything runs in Docker - no shell scripts needed!
# Works the same on Windows, macOS, and Linux.
#
# Access:
#   - SDN Controller:  http://localhost:8090
#   - Relay Tokyo:     https://localhost:4433 (Health: http://localhost:8080)
#   - Relay London:    https://localhost:4434 (Health: http://localhost:8081)
#   - Relay New York:  https://localhost:4435 (Health: http://localhost:8082)

services:
  # SDN Controller - Network Brain
  sdn:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-sdn
    command: ["sdn", "-config", "/tmp/config.sdn.yaml"]
    ports:
      - "8090:8090"
    environment:
      - SDN_ADDR=:8090
      - DATA_DIR=/data
    volumes:
      - sdn-data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8090/graph"]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    networks:
      qumo-net:
        aliases:
          - sdn

  # Relay Server - Tokyo
  relay-tokyo:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-tokyo
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4433:4433/udp"
      - "8080:8080"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - HEALTH_ADDR=:8080
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-tokyo
      - REGION=asia
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - London
  relay-london:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-london
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4434:4433/udp"
      - "8081:8080"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - HEALTH_ADDR=:8080
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-london
      - REGION=europe
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - New York
  relay-newyork:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-newyork
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4435:4433/udp"
      - "8082:8080"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - HEALTH_ADDR=:8080
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-newyork
      - REGION=americas
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Setup Service - Automatically configures network topology
  # This runs once and exits after configuring the demo network
  setup:
    image: curlimages/curl:latest
    container_name: qumo-setup
    depends_on:
      relay-tokyo:
        condition: service_healthy
      relay-london:
        condition: service_healthy
      relay-newyork:
        condition: service_healthy
    networks:
      - qumo-net
    command: >
      sh -c "
        echo 'üöÄ Setting up qumo demo network...' &&
        echo 'üì° Registering relay topology...' &&
        
        curl -X PUT http://sdn:8090/relay/relay-tokyo \
          -H 'Content-Type: application/json' \
          -d '{\"neighbors\": [{\"name\": \"relay-london\", \"latency_ms\": 250}]}' \
          -s -o /dev/null -w 'Tokyo registered (HTTP %{http_code})\n' &&
        
        curl -X PUT http://sdn:8090/relay/relay-london \
          -H 'Content-Type: application/json' \
          -d '{\"neighbors\": [{\"name\": \"relay-tokyo\", \"latency_ms\": 250}, {\"name\": \"relay-newyork\", \"latency_ms\": 80}]}' \
          -s -o /dev/null -w 'London registered (HTTP %{http_code})\n' &&
        
        curl -X PUT http://sdn:8090/relay/relay-newyork \
          -H 'Content-Type: application/json' \
          -d '{\"neighbors\": [{\"name\": \"relay-london\", \"latency_ms\": 80}]}' \
          -s -o /dev/null -w 'New York registered (HTTP %{http_code})\n' &&
        
        echo '' &&
        echo '‚úÖ Demo network configured!' &&
        echo '' &&
        echo 'üìä Network Topology:' &&
        echo '   relay-tokyo (Asia) <--250ms--> relay-london (Europe) <--80ms--> relay-newyork (Americas)' &&
        echo '' &&
        echo 'üéØ Access URLs:' &&
        echo '  - SDN Dashboard:   http://localhost:8090' &&
        echo '  - Relay Tokyo:     https://localhost:4433 (metrics: :8080)' &&
        echo '  - Relay London:    https://localhost:4434 (metrics: :8081)' &&
        echo '  - Relay New York:  https://localhost:4435 (metrics: :8082)' &&
        echo '' &&
        echo 'üîç Try: curl http://localhost:8090/graph' &&
        echo 'üîç Try: curl \"http://localhost:8090/route?from=relay-tokyo&to=relay-newyork\"'
      "
    restart: "no"

networks:
  qumo-net:
    driver: bridge

volumes:
  sdn-data:

# How it works:
#
# 1. Start everything (network topology auto-configured):
#    docker compose -f docker compose.simple.yml up
#
#    The 'setup' service automatically configures the network topology.
#    Watch the logs to see the setup progress!
#
# 2. Explore the network:
#    # View topology graph
#    curl http://localhost:8090/graph | jq
#
#    # Find shortest path from Tokyo to New York
#    curl "http://localhost:8090/route?from=relay-tokyo&to=relay-newyork"
#
#    # Check relay health
#    curl http://localhost:8080/health  # Tokyo
#    curl http://localhost:8081/health  # London
#    curl http://localhost:8082/health  # New York
#
# 3. View logs:
#    docker compose -f docker compose.simple.yml logs -f
#
# 4. Stop demo:
#    docker compose -f docker compose.simple.yml down
#
# No shell scripts required! Works the same on all platforms.
