# Docker Compose for External Users
#
# This compose file uses pre-built images from GitHub Container Registry.
# No local build required - ideal for quickly testing or deploying qumo.
#
# Usage:
#   docker compose -f docker compose.external.yml up -d
#
# Prerequisites:
#   1. Create config files (or use the defaults in the repo)
#   2. Generate TLS certificates:
#      mkdir -p certs
#      mkcert -cert-file certs/server.crt -key-file certs/server.key localhost 127.0.0.1 ::1

version: '3.8'

services:
  # SDN Controller
  sdn:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-sdn
    command: ["sdn", "-config", "config.sdn.yaml"]
    ports:
      - "8090:8090"
    volumes:
      - ./config.sdn.yaml:/app/config.sdn.yaml:ro
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/graph"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - qumo-net

  # Relay Server
  relay:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay
    command: ["relay", "-config", "config.relay.yaml"]
    ports:
      - "4433:4433/udp"  # MoQT (QUIC)
      - "8080:8080"      # HTTP health check
    volumes:
      - ./config.relay.yaml:/app/config.relay.yaml:ro
      - ./certs:/app/certs:ro
    depends_on:
      sdn:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - qumo-net

networks:
  qumo-net:
    driver: bridge

volumes:
  data:
