# Simple Docker Compose - Complete Demo Environment
# Usage: docker compose -f docker/docker-compose.simple.yml up

services:
  # SDN Controller - Network Brain
  sdn:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-sdn
    command: ["sdn", "-config", "/tmp/config.sdn.yaml"]
    ports:
      - "8090:8090"
    environment:
      - SDN_ADDR=:8090
      - DATA_DIR=/data
      - NODE_TTL_SEC=90
    volumes:
      - sdn-data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8090/graph"]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    networks:
      qumo-net:
        aliases:
          - sdn

  # Relay Server - Tokyo
  relay-tokyo:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-tokyo
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4433:4433/udp"
      - "8080:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-tokyo
      - REGION=asia
      - NEIGHBORS=relay-london:250
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - London
  relay-london:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-london
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4434:4433/udp"
      - "8081:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-london
      - REGION=europe
      - NEIGHBORS=relay-tokyo:250,relay-newyork:80
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

  # Relay Server - New York
  relay-newyork:
    image: ghcr.io/okdaichi/qumo:latest
    container_name: qumo-relay-newyork
    command: ["relay", "-config", "/tmp/config.relay.yaml"]
    ports:
      - "4435:4433/udp"
      - "8082:4433"
    environment:
      - RELAY_ADDR=0.0.0.0:4433
      - INSECURE=true
      - SDN_URL=http://sdn:8090
      - RELAY_NAME=relay-newyork
      - REGION=americas
      - NEIGHBORS=relay-london:80
    depends_on:
      sdn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4433/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - qumo-net

networks:
  qumo-net:
    driver: bridge

volumes:
  sdn-data:

# How it works:
# 1. Start everything:
#    docker compose -f docker/docker-compose.simple.yml up
# 2. Explore the network:
#    curl http://localhost:8090/graph | jq
#    curl "http://localhost:8090/route?from=relay-tokyo&to=relay-newyork"
# 3. View logs:
#    docker compose -f docker/docker-compose.simple.yml logs -f
# 4. Stop demo:
#    docker compose -f docker/docker-compose.simple.yml down